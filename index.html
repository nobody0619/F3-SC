<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>纪老师 F3 SC 不会做到会</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:700px; margin:auto; text-align:center; }
    #welcome,#menu,#quiz,#finish { margin:20px; }
    #menu,#quiz,#finish { display:none; }
    #menu button,#controls button { margin:5px; padding:8px 12px; }
    .question { text-align:left; margin:15px 0; padding-left:20px; }
    .option-label { display:block; margin:5px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:10px 0; }
    progress { width:100%; height:20px; }
    input[type="text"] { width:100%; padding:6px; margin:5px 0; }
    input[type="radio"],input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
    .question img { max-width:100%; height:auto; display:block; margin:8px 0; }
  </style>
</head>
<body>

  <!-- 1. 欢迎 & 姓名输入 -->
  <div id="welcome">
    <h2>请输入姓名 / Enter Your Name</h2>
    <input type="text" id="username" placeholder="姓名 / Name"/>
    <button id="startBtn" type="button">开始测验 / Start Quiz</button>
  </div>

  <!-- 2. 章节选择 -->
  <div id="menu">
    <h2>请选择章节 / Select Chapter</h2>
    <!-- JS 动态插入章节按钮 -->
  </div>

  <!-- 3. 测验区域 -->
  <div id="quiz">
    <h3 id="quiz-title"></h3>
    <div id="score">得分: 0</div>
    <div id="remaining">剩余题目: 0</div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="question-area"></div>
  </div>

  <!-- 4. 本节完成 & 上传成绩 -->
  <div id="finish">
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <div id="controls"></div>
  </div>

  <!-- 隐藏 iframe + form 用于提交成绩 -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm"
        action="https://script.google.com/macros/s/AKfycbwOadAK74XfAiOFkokD6zlQ8kQZTFDI0_SVWwMSSRgT8mwuoCac2VSAIj8X07L7NVVF/exec"
        method="post" target="postFrame" style="display:none;">
    <input name="quizId"/>
    <input name="name"/>
    <input name="score"/>
    <input name="correct"/>
    <input name="wrong"/>
    <input name="time"/>
  </form>

<script>
document.addEventListener('DOMContentLoaded',()=> {
  let user = '';
  let chapters = [], grouped = {};
  let chapterKey, sectionKey, labelKey, sheetKey;
  let currentChapter = '', sectionList = [], secIndex = 0;
  let qs = [], queue = [], score = 0, correct = 0, wrong = 0;
  let chapterStart = 0;
  const MAX_OPTS = 15;

  // 1) 绑定 “开始测验”
  document.getElementById('startBtn').addEventListener('click',()=>{
    const nm = document.getElementById('username').value.trim();
    if(!nm) return alert('请输入姓名');
    user = nm;
    document.getElementById('welcome').style.display = 'none';
    loadChapters();
  });

  // 2) 加载 Chapters.csv
  function loadChapters() {
    Papa.parse('Chapters.csv',{ download:true, header:true, skipEmptyLines:true,
      complete(res) {
        // 统一章节表键名（去空格 & 小写）
        chapters = res.data.map(raw=>{
          const r={};
          Object.entries(raw).forEach(([k,v])=>{
            const key = String(k||'').trim().toLowerCase();
            r[key] = typeof v==='string'? v.trim():v;
          });
          return r;
        });
        if(!chapters.length) return alert('请检查 Chapters.csv');
        chapterKey = 'chapter';
        sectionKey = 'section';
        labelKey   = 'label';
        sheetKey   = 'sheet';
        if(!chapters[0][chapterKey] || !chapters[0][sectionKey] || !chapters[0][labelKey] || !chapters[0][sheetKey]) {
          return alert('Chapters.csv 列名需包含 chapter, section, label, sheet');
        }

        grouped = {};
        chapters.forEach(r=>{
          const c = r[chapterKey];
          if(!grouped[c]) grouped[c]=[];
          grouped[c].push(r);
        });
        const menu = document.getElementById('menu');
        menu.style.display = 'block';
        menu.innerHTML = '<h2>请选择章节 / Select Chapter</h2>';
        Object.keys(grouped).forEach(chap=>{
          const btn = document.createElement('button');
          btn.textContent = chap;
          btn.onclick = ()=>startChapter(chap);
          menu.appendChild(btn);
        });
      }
    });
  }

  // 3) 点击章节
  function startChapter(chap) {
    currentChapter = chap;
    sectionList = grouped[chap]
      .sort((a,b)=> String(a[sectionKey]).localeCompare(String(b[sectionKey])));
    secIndex = 0;
    document.getElementById('menu').style.display='none';
    loadSection();
  }

  // 4) 加载分节题库（统一题库键名）
  function loadSection() {
    const sec = sectionList[secIndex];
    document.getElementById('quiz-title').textContent =
      `${currentChapter} – ${sec[sectionKey]}: ${sec[labelKey]}`;
    score=correct=wrong=0;
    chapterStart = Date.now();

    Papa.parse(sec[sheetKey],{ download:true, header:true, skipEmptyLines:true,
      complete(r) {
        qs = r.data.map(raw=>{
          const q = {};
          for (const [k,v] of Object.entries(raw)) {
            const key = String(k||'').trim().toLowerCase(); // 全部小写
            q[key] = typeof v === 'string' ? v.trim() : v;
          }
          // 题型默认单选
          q.type = (q.type || 'radio').toLowerCase();
          q.attempt = 0;
          return q;
        });
        queue = shuffle([...qs]);
        document.getElementById('quiz').style.display='block';
        document.getElementById('finish').style.display='none';
        updateUI(0);
        nextQ();
      }
    });
  }

  // 更新 UI
  function updateUI(delta) {
    const deltaTxt = delta ? ` (${delta>0?'+':''}${delta})` : '';
    document.getElementById('score').textContent = `得分: ${score}${deltaTxt}`;
    document.getElementById('remaining').textContent = `剩余题目: ${queue.length}`;
    const pg = document.getElementById('progress');
    pg.max = qs.length; pg.value = qs.length - queue.length;
  }

  // 渲染下一题或结束本节
  function nextQ() {
    const qa = document.getElementById('question-area');
    qa.innerHTML=''; updateUI(0);
    if(queue.length===0) return finishSection();

    const q = queue.shift();
    const div = document.createElement('div');
    div.className='question';

    // 题干
    const safeQ = (q.question || '').replace(/\r?\n/g, '<br/>');
    div.innerHTML=`<p><strong>${safeQ}</strong></p>`;

    // === 渲染图片（支持多个，| 分隔），相对/绝对路径均可 ===
    if (q.image) {
      const imgs = String(q.image).split('|').map(s => s.trim()).filter(Boolean);
      if (imgs.length) {
        const wrap = document.createElement('div');
        wrap.style.margin = '10px 0';
        imgs.forEach(src0 => {
          const src = normalizeImageURL(src0);
          const img = document.createElement('img');
          // 防止缓存（可移除）
          img.src = src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now();
          img.alt = 'question image';
          wrap.appendChild(img);
        });
        div.appendChild(wrap);
      }
    }

    // 选项/作答
    const opts = document.createElement('div'); opts.className='options';
    if(q.type==='text') {
      opts.innerHTML='<input type="text" id="txtAns" placeholder="请输入答案…"/>';
    } else {
      const letters = Array.from({length:MAX_OPTS},(_,i)=>String.fromCharCode(65+i)); // A..O
      // 只取存在内容的选项（注意我们题库键名已小写，因此访问时转成小写）
      const ex
